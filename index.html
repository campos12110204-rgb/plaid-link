<script>
  const BACKEND_URL = "https://plaid-backend-8vsj.onrender.com";

  fetch(`${BACKEND_URL}/create_link_token`, { method: "POST" })
    .then(res => res.json())
    .then(data => {

      if (!data.link_token) {
        document.body.innerHTML = "Failed to fetch link token.";
        return;
      }

      const handler = Plaid.create({
        token: data.link_token,

        onSuccess: function(public_token, metadata) {

          fetch(`${BACKEND_URL}/exchange_public_token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ public_token: public_token })
          })
          .then(res => res.json())
          .then(result => {
            console.log("Access token:", result.access_token);

            // âœ… Redirect back to app
            window.location.href = "myapp://success";
          })
          .catch(err => {
            console.error("Error exchanging token:", err);
            alert("Failed to connect bank.");
          });
        },

        onExit: function(err, metadata) {
          console.log("User exited Plaid Link", err, metadata);
        }
      });

      handler.open();
    })
    .catch(err => {
      console.error("Error fetching link token:", err);
      document.body.innerHTML = "Error fetching link token.";
    });
</script>
